<div class="min-h-screen">
  @if (loading()) {
    <div class="fixed inset-0 bg-white/70 flex items-center justify-center z-50">
      <div class="flex flex-col items-center">
        <i class="fa-solid fa-spinner fa-spin text-4xl text-amber-600"></i>
        <p class="mt-4 text-lg text-gray-700">Đang tải thực đơn...</p>
      </div>
    </div>
  }
  @if (error()) {
    <div class="fixed inset-0 bg-red-100 flex items-center justify-center z-50">
      <div class="text-center">
        <i class="fa-solid fa-triangle-exclamation text-4xl text-red-600"></i>
        <p class="mt-4 text-lg text-red-700">Không thể tải thực đơn: {{ error() }}</p>
      </div>
    </div>
  }

  @if (menuData(); as data) {
    <div class="container mx-auto p-4 md:p-8">
      <header class="mb-8 p-6 bg-white rounded-xl shadow-lg">
        <div class="flex flex-col md:flex-row items-center gap-6">
          <img [src]="data.pos_parent.Logo_Image" alt="Logo Thương hiệu" class="h-24 w-24 rounded-full object-cover border-4 border-amber-100">
          <div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center md:text-left">Order chung Phúc Thịnh</h1>
            <h2 class="text-lg text-amber-700 font-semibold text-center md:text-left">{{ data.pos.Pos_Name }}</h2>
            <p class="text-gray-500 mt-2 text-center md:text-left"><i class="fa-solid fa-location-dot mr-2"></i>{{ data.pos.Pos_Address }}</p>
          </div>
        </div>
      </header>

      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Left Sidebar - Categories -->
        <aside class="lg:w-1/5 lg:sticky lg:top-8 self-start bg-white p-4 rounded-xl shadow-md">
          <h3 class="text-xl font-bold mb-4 border-b pb-2 text-gray-700">Danh mục</h3>
          <nav class="flex flex-row lg:flex-col gap-2 overflow-x-auto pb-2">
            @for(group of groupedItems(); track group.category.id) {
              <a (click)="scrollToCategory(group.category.text_id)" 
                 class="whitespace-nowrap cursor-pointer text-left px-4 py-2 rounded-lg text-gray-600 hover:bg-amber-100 hover:text-amber-800 font-medium transition-colors duration-200">
                {{ group.category.name }}
              </a>
            }
          </nav>
        </aside>

        <!-- Main Content - Menu Items -->
        <main class="w-full lg:w-3/5">
          @for(group of groupedItems(); track group.category.id) {
            <section [id]="group.category.text_id" class="mb-12">
              <h2 class="text-3xl font-bold text-gray-800 mb-6 border-l-4 border-amber-500 pl-4">{{ group.category.name }}</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                @for(item of group.items; track item.id) {
                  <div (click)="openItemModal(item)" class="bg-white rounded-xl shadow-md overflow-hidden flex items-center gap-4 p-4 cursor-pointer hover:shadow-xl hover:scale-[1.02] transition-all duration-300">
                    @if (item.image_url) {
                      <img [src]="item.image_url" [alt]="item.name" class="w-28 h-28 object-cover rounded-lg shrink-0">
                    } @else {
                      <div class="w-28 h-28 bg-gray-200 rounded-lg flex items-center justify-center text-gray-400 shrink-0">
                        <i class="fa-solid fa-mug-saucer text-3xl"></i>
                      </div>
                    }
                    <div class="flex-grow">
                      <h3 class="font-bold text-lg text-gray-800">{{ item.name }}</h3>
                      <p class="text-gray-500 text-sm mt-1 line-clamp-2">{{ item.description }}</p>
                      <div class="flex items-center justify-between mt-2">
                        <span class="font-semibold text-amber-700 text-lg">{{ item.ta_price | currency:'VND':'symbol':'1.0-0' }}</span>
                        <div class="bg-amber-500 text-white rounded-full h-8 w-8 flex items-center justify-center">
                          <i class="fa-solid fa-plus"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </section>
          }
        </main>

        <!-- Right Sidebar - Cart -->
        <aside class="lg:w-1/5 lg:sticky lg:top-8 self-start">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 border-b pb-2 text-gray-700">Đơn hàng của bạn ({{ cartCount() }})</h3>
                @if (cart().length === 0) {
                    <div class="text-center py-10 text-gray-400">
                        <i class="fa-solid fa-cart-shopping text-4xl mb-2"></i>
                        <p>Giỏ hàng của bạn trống.</p>
                    </div>
                } @else {
                    <div class="max-h-[60vh] overflow-y-auto pr-2 -mr-2">
                        @for(cartItem of cart(); track getCartItemIdentifier(cartItem)) {
                            <div class="mb-4">
                                <div class="flex gap-3">
                                    <img [src]="cartItem.image_url" [alt]="cartItem.name" class="w-16 h-16 object-cover rounded-md shrink-0">
                                    <div class="flex-grow text-sm">
                                        <p class="font-bold text-gray-800">{{ cartItem.name }}</p>
                                        @for(opt of cartItem.options; track opt.option) {
                                            <p class="text-gray-500 text-xs">+ {{opt.option}}</p>
                                        }
                                        <p class="font-semibold text-amber-700 mt-1">{{ cartItem.finalPrice | currency:'VND':'symbol':'1.0-0' }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center justify-end gap-2 mt-2">
                                    <button (click)="updateQuantity(cartItem, -1)" class="w-7 h-7 bg-gray-200 rounded-full text-gray-700 hover:bg-gray-300 transition">-</button>
                                    <span class="font-bold w-6 text-center">{{ cartItem.quantity }}</span>
                                    <button (click)="updateQuantity(cartItem, 1)" class="w-7 h-7 bg-amber-500 text-white rounded-full hover:bg-amber-600 transition">+</button>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="border-t pt-4 mt-4">
                        <div class="flex justify-between items-center font-bold text-lg">
                            <span>Tổng cộng:</span>
                            <span>{{ cartTotal() | currency:'VND':'symbol':'1.0-0' }}</span>
                        </div>
                        <button (click)="openCheckoutModal()"
                                [disabled]="cart().length === 0"
                                class="w-full bg-green-500 text-white font-bold py-3 rounded-lg mt-4 hover:bg-green-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                            Gửi đơn
                        </button>
                    </div>
                }
            </div>
        </aside>
      </div>
    </div>
  }
  
  <app-item-modal 
    [item]="selectedItem()" 
    (closeModal)="closeItemModal()" 
    (addToCart)="handleAddToCart($event)">
  </app-item-modal>

  <app-checkout-modal
    [isOpen]="isCheckoutModalOpen()"
    [status]="checkoutStatus()"
    (closeModal)="closeCheckoutModal()"
    (confirmOrder)="handleConfirmOrder($event)">
  </app-checkout-modal>
</div>